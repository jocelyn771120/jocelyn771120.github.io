<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Angr学习之符号表达式和约束求解 | Limpidity</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<nav class="navbar">
    <div class="layout">
        <div class="content ">
            
            
            <a href="/.">Home</a>
            
            
            
            <a href="/archives">Archive</a>
            
            
        </div>
    </div>
</nav>

<main class="post">
    <article>
    <h1 class="article-title">
        <a href="/2018/07/10/20180710-more/">Angr学习之符号表达式和约束求解</a>
    </h1>

    <section class="article-meta">
        <p class="article-date">July 10 2018</p>
    </section>

    <section class="article-entry">
        <h1 id="关于约束求解"><a href="#关于约束求解" class="headerlink" title="关于约束求解"></a>关于约束求解</h1><p><strong>参考文档：<a href="https://docs.angr.io/docs/solver.html" target="_blank" rel="external">https://docs.angr.io/docs/solver.html</a></strong><br>除了可以当作模拟器，Angr还有一个东西叫做符号变量，通过它执行算术运算产生AST（百度了一下AST，是一种抽象语法树的数据结构，稍微的看了一下感觉又是在重新预习编译原理），这个抽象运算树可以成为求解器的约束。    </p>
<p>当给你一个做了运算操作的输出结果，那么输入是什么？这个问题就可以用Angr来解决。    </p>
<h1 id="关于Claripy"><a href="#关于Claripy" class="headerlink" title="关于Claripy"></a>关于Claripy</h1><p><strong>参考文档：<a href="https://docs.angr.io/docs/claripy.html" target="_blank" rel="external">https://docs.angr.io/docs/claripy.html</a></strong>    </p>
<p>Claripy是angr的一个关于求解程序引擎的库，claripy ASTs提供一种联系具体值和符号表达的方式。</p>
<p>Claripy这个库总共提供了三种类型的AST：BV,FP,Bool，支持多种类型的数据，比如说bitvector，floating-point number,布尔操作。</p>
<p><img src="http://osuzegp2h.bkt.clouddn.com/201807104.jpg" alt="images">    </p>
<h1 id="0x3-03-angr-symbolic-registers"><a href="#0x3-03-angr-symbolic-registers" class="headerlink" title="0x3 03_angr_symbolic_registers"></a>0x3 03_angr_symbolic_registers</h1><p><img src="http://osuzegp2h.bkt.clouddn.com/201807111.jpg" alt="images">    </p>
<p><img src="http://osuzegp2h.bkt.clouddn.com/201807112.jpg" alt="images">    </p>
<p><img src="http://osuzegp2h.bkt.clouddn.com/201807113.jpg" alt="images"></p>
<p><img src="http://osuzegp2h.bkt.clouddn.com/201807114.jpg" alt="images"></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding:UTF-8 -*-</span></div><div class="line"><span class="keyword">import</span> sys,angr</div><div class="line"><span class="keyword">import</span> claripy</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">	</div><div class="line">	pro=angr.Project(<span class="string">"./03_angr_symbolic_registers"</span>)</div><div class="line">	</div><div class="line">	<span class="comment">#start_addr:符号执行需要开始的地址</span></div><div class="line">	<span class="comment">#blank_state函数:起始运行地址由addr决定</span></div><div class="line">	<span class="comment">#entry_state函数：起始运行地址由初始运行状态决定</span></div><div class="line">	start_addr=<span class="number">0x80488d1</span></div><div class="line">	state=pro.factory.blank_state(addr=start_addr)</div><div class="line">	</div><div class="line">	<span class="comment">#BVS的作用就是创造一个符号变量</span></div><div class="line">	pwd0=claripy.BVS(<span class="string">'pwd0'</span>,<span class="number">32</span>)</div><div class="line">	pwd1=claripy.BVS(<span class="string">'pwd1'</span>,<span class="number">32</span>)</div><div class="line">	pwd2=claripy.BVS(<span class="string">'pwd2'</span>,<span class="number">32</span>)</div><div class="line">	</div><div class="line">	<span class="comment">#将模拟程序状态的Simstate对象的寄存器设置为符号变量的值,原因看上图</span></div><div class="line">	state.regs.eax=pwd0</div><div class="line">	state.regs.ebx=pwd1</div><div class="line">	state.regs.edx=pwd2</div><div class="line">	</div><div class="line">	simulation=pro.factory.simgr(state)</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">if_success</span><span class="params">(state)</span>:</span></div><div class="line">		stdout_res=state.posix.dumps(sys.stdout.fileno())</div><div class="line">		<span class="keyword">return</span> <span class="string">"Good Job."</span> <span class="keyword">in</span> stdout_res</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">if_fail</span><span class="params">(state)</span>:</span></div><div class="line">		stdout_res=state.posix.dumps(sys.stdout.fileno())</div><div class="line">		<span class="keyword">return</span> <span class="string">"Try again."</span> <span class="keyword">in</span> stdout_res</div><div class="line">	</div><div class="line">	simulation.explore(find=if_success,avoid=if_fail)</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> simulation.found:</div><div class="line">		solution=simulation.found[<span class="number">0</span>]</div><div class="line">		</div><div class="line">		solution0=solution.se.eval(pwd0)</div><div class="line">		solution1=solution.se.eval(pwd1)</div><div class="line">		solution2=solution.se.eval(pwd2)</div><div class="line">		<span class="comment">#se表示solver engine(符号执行)</span></div><div class="line">		</div><div class="line">        <span class="keyword">print</span> <span class="string">' '</span>.join(map(<span class="string">'&#123;:x&#125;'</span>.format,[solution0,solution1,solution2]))</div><div class="line">		</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
    </section>
</article>

</main>
<footer class="footer">
    <p>Powered by Moren YANG&nbsp;&nbsp;-&nbsp;&nbsp;ackn. <a href="https://hexo.io"> Hexo </a></p>
</footer>

</body>
</html>
