<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Angr学习（三） | Limpidity</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
<nav class="navbar">
    <div class="layout">
        <div class="content ">
            
            
            <a href="/.">Home</a>
            
            
            
            <a href="/archives">Archive</a>
            
            
        </div>
    </div>
</nav>

<main class="post">
    <article>
    <h1 class="article-title">
        <a href="/2018/07/12/20180712/">Angr学习（三）</a>
    </h1>

    <section class="article-meta">
        <p class="article-date">July 12 2018</p>
    </section>

    <section class="article-entry">
        <h1 id="0x4-04-angr-symbolic-stack"><a href="#0x4-04-angr-symbolic-stack" class="headerlink" title="0x4 04_angr_symbolic_stack"></a>0x4 04_angr_symbolic_stack</h1><p><img src="http://osuzegp2h.bkt.clouddn.com/201807115.jpg" alt="images">     </p>
<p>这题和03不一样的地方是把输入放在了栈上。    </p>
<p>分析一下这栈上的变化：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x08048679</span> &lt;+<span class="number">0</span>&gt;:     <span class="keyword">push</span>   <span class="built_in">ebp</span></div><div class="line">   <span class="number">0x0804867a</span> &lt;+<span class="number">1</span>&gt;:     <span class="keyword">mov</span>    <span class="built_in">ebp</span>,<span class="built_in">esp</span></div><div class="line">   <span class="number">0x0804867c</span> &lt;+<span class="number">3</span>&gt;:     <span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0x18</span></div><div class="line">   <span class="number">0x0804867f</span> &lt;+<span class="number">6</span>&gt;:     <span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0x4</span></div><div class="line">   <span class="number">0x08048682</span> &lt;+<span class="number">9</span>&gt;:     <span class="keyword">lea</span>    <span class="built_in">eax</span>,[<span class="built_in">ebp</span>-<span class="number">0x10</span>]</div><div class="line">   <span class="number">0x08048685</span> &lt;+<span class="number">12</span>&gt;:    <span class="keyword">push</span>   <span class="built_in">eax</span></div><div class="line">   <span class="number">0x08048686</span> &lt;+<span class="number">13</span>&gt;:    <span class="keyword">lea</span>    <span class="built_in">eax</span>,[<span class="built_in">ebp</span>-<span class="number">0xc</span>]</div><div class="line">   <span class="number">0x08048689</span> &lt;+<span class="number">16</span>&gt;:    <span class="keyword">push</span>   <span class="built_in">eax</span></div><div class="line">   <span class="number">0x0804868a</span> &lt;+<span class="number">17</span>&gt;:    <span class="keyword">push</span>   <span class="number">0x80487b3</span></div><div class="line">   <span class="number">0x0804868f</span> &lt;+<span class="number">22</span>&gt;:    <span class="keyword">call</span>   <span class="number">0x8048370</span> &lt;__isoc99_scanf@plt&gt;</div></pre></td></tr></table></figure>
<p>此时栈上的内容：<br><img src="http://osuzegp2h.bkt.clouddn.com/201807121.jpg" alt="images">    </p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0</span>x08048694 &lt;+<span class="number">27</span>&gt;:    <span class="keyword">add</span><span class="bash">    esp,0x10</span></div></pre></td></tr></table></figure>
<p>此时栈上的内容：<br><img src="http://osuzegp2h.bkt.clouddn.com/201807122.jpg" alt="images">   </p>
<p>假设我们要跳过输入直接从<code>scanf</code>之后开始执行的话，我们必须保证操作的时候<code>ebp</code>和<code>esp</code>与正常程序运行的时候相同，可以看到<code>add esp,0x10</code>之后，<code>esp</code>的位置是和进入<code>handle_user</code>函数后<code>sub esp 0x18</code>（记住<code>push ebp</code>之后的0x18是给局部变量用的空间)之后的位置相同。    </p>
<p>那么我们在写脚本的时候，在设置完程序的入口点为<code>0x08048697</code>之后，把<code>ebp</code>的值设置为此时<code>esp</code>的值，我们就还原了正常程序运行时栈上的状态，接下来要操作的数据就都可以在栈上完成。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x08048697</span> &lt;+<span class="number">30</span>&gt;:    <span class="keyword">mov</span>    <span class="built_in">eax</span>,<span class="built_in">DWORD</span> <span class="built_in">PTR</span> [<span class="built_in">ebp</span>-<span class="number">0xc</span>]	//[<span class="built_in">ebp</span>-<span class="number">0xc</span>]</div><div class="line"><span class="number">0x0804869a</span> &lt;+<span class="number">33</span>&gt;:    <span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0xc</span></div><div class="line"><span class="number">0x0804869d</span> &lt;+<span class="number">36</span>&gt;:    <span class="keyword">push</span>   <span class="built_in">eax</span></div><div class="line"><span class="number">0x0804869e</span> &lt;+<span class="number">37</span>&gt;:    <span class="keyword">call</span>   <span class="number">0x80484a9</span> &lt;complex_function0&gt;</div><div class="line"><span class="number">0x080486a3</span> &lt;+<span class="number">42</span>&gt;:    <span class="keyword">add</span>    <span class="built_in">esp</span>,<span class="number">0x10</span></div><div class="line"><span class="number">0x080486a6</span> &lt;+<span class="number">45</span>&gt;:    <span class="keyword">mov</span>    <span class="built_in">DWORD</span> <span class="built_in">PTR</span> [<span class="built_in">ebp</span>-<span class="number">0xc</span>],<span class="built_in">eax</span>	</div><div class="line"><span class="number">0x080486a9</span> &lt;+<span class="number">48</span>&gt;:    <span class="keyword">mov</span>    <span class="built_in">eax</span>,<span class="built_in">DWORD</span> <span class="built_in">PTR</span> [<span class="built_in">ebp</span>-<span class="number">0x10</span>]	//[<span class="built_in">ebp</span>-<span class="number">0x10</span>]</div><div class="line"><span class="number">0x080486ac</span> &lt;+<span class="number">51</span>&gt;:    <span class="keyword">sub</span>    <span class="built_in">esp</span>,<span class="number">0xc</span></div><div class="line"><span class="number">0x080486af</span> &lt;+<span class="number">54</span>&gt;:    <span class="keyword">push</span>   <span class="built_in">eax</span></div><div class="line"><span class="number">0x080486b0</span> &lt;+<span class="number">55</span>&gt;:    <span class="keyword">call</span>   <span class="number">0x8048591</span> &lt;complex_function1&gt;</div><div class="line"><span class="number">0x080486b5</span> &lt;+<span class="number">60</span>&gt;:    <span class="keyword">add</span>    <span class="built_in">esp</span>,<span class="number">0x10</span></div></pre></td></tr></table></figure>
<p>所以接下来要考虑的事情，就是把符号变量放在栈上的哪一块。从上图我们可以看出我们输入的两个格式化字符串分别放在了<code>ebp-0xc</code>和<code>ebp-0x10</code>的位置上，所以我们在符号执行的时候就把我们的符号变量放在相同位置上就OK了。至于放数据的话，就是通过改变<code>esp</code>,因为有8个字节是需要<code>padding</code>掉的。    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> angr,sys</div><div class="line"><span class="keyword">import</span> claripy</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">	</div><div class="line">	pro=angr.Project(<span class="string">'./04_angr_symbolic_stack'</span>)</div><div class="line">	</div><div class="line">	origin_state=pro.factory.blank_state(addr=<span class="number">0x08048697</span>)</div><div class="line">	</div><div class="line">	origin_state.regs.ebp=origin_state.regs.esp</div><div class="line">	origin_state.regs.esp-=<span class="number">8</span>	<span class="comment">#padding size</span></div><div class="line">	</div><div class="line">	input1=claripy.BVS(<span class="string">'input1'</span>,<span class="number">32</span>)</div><div class="line">	input2=claripy.BVS(<span class="string">'input2'</span>,<span class="number">32</span>)</div><div class="line">	</div><div class="line">	origin_state.stack_push(input1)</div><div class="line">	origin_state.stack_push(input2)</div><div class="line">	</div><div class="line">	state=pro.factory.simgr(origin_state)</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">is_success</span><span class="params">(state)</span>:</span></div><div class="line">		stdout_res=state.posix.dumps(sys.stdout.fileno())</div><div class="line">		<span class="keyword">return</span> <span class="string">'Good Job.'</span> <span class="keyword">in</span> stdout_res</div><div class="line">		</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">is_avoid</span><span class="params">(state)</span>:</span></div><div class="line">		stdout_res=state.posix.dumps(sys.stdout.fileno())</div><div class="line">		<span class="keyword">return</span> <span class="string">'Try again.'</span> <span class="keyword">in</span> stdout_res</div><div class="line">		</div><div class="line">	state.explore(find=is_success,avoid=is_avoid)</div><div class="line">	</div><div class="line">	<span class="keyword">if</span> state.found:</div><div class="line">		res=state.found[<span class="number">0</span>]</div><div class="line">		</div><div class="line">		res_input1=res.se.eval(input1)</div><div class="line">		res_input2=res.se.eval(input2)</div><div class="line">		</div><div class="line">		<span class="keyword">print</span> <span class="string">' '</span>.join(map(str,[res_input1,res_input2]))</div><div class="line">		</div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">	main()</div></pre></td></tr></table></figure>
    </section>
</article>

</main>
<footer class="footer">
    <p>Powered by Moren YANG&nbsp;&nbsp;-&nbsp;&nbsp;ackn. <a href="https://hexo.io"> Hexo </a></p>
</footer>

</body>
</html>
